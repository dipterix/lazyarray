<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create or load a lazyarray instance — lazyarray • lazyarray</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Create or load a lazyarray instance — lazyarray" />
<meta property="og:description" content="Creates or load a lazyarray that stores data on the hard 
disks. The data content is load on demand." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lazyarray</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/basic-usage-of-lazyarray.html">A Basic Usage of 'LazyArray'</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/dipterix/lazyarray/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create or load a <code>lazyarray</code> instance</h1>
    <small class="dont-index">Source: <a href='https://github.com/dipterix/lazyarray/blob/master/R/lazyarray.R'><code>R/lazyarray.R</code></a></small>
    <div class="hidden name"><code>lazyarray.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Creates or load a <code>lazyarray</code> that stores data on the hard 
disks. The data content is load on demand.</p>
    </div>

    <pre class="usage"><span class='fu'>lazyarray</span><span class='op'>(</span>
  <span class='va'>path</span>,
  <span class='va'>dim</span>,
  read_only <span class='op'>=</span> <span class='cn'>FALSE</span>,
  type <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"filearray"</span>, <span class='st'>"fstarray"</span><span class='op'>)</span>,
  storage_format <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"double"</span>, <span class='st'>"integer"</span>, <span class='st'>"complex"</span>, <span class='st'>"character"</span><span class='op'>)</span>,
  meta_name <span class='op'>=</span> <span class='st'>"lazyarray.meta"</span>
<span class='op'>)</span>

<span class='fu'>fstarray</span><span class='op'>(</span>
  <span class='va'>path</span>,
  <span class='va'>dim</span>,
  read_only <span class='op'>=</span> <span class='cn'>FALSE</span>,
  storage_format <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"double"</span>, <span class='st'>"integer"</span>, <span class='st'>"complex"</span>, <span class='st'>"character"</span><span class='op'>)</span>,
  meta_name <span class='op'>=</span> <span class='st'>"lazyarray.meta"</span>
<span class='op'>)</span>

<span class='fu'>filearray</span><span class='op'>(</span>
  <span class='va'>path</span>,
  <span class='va'>dim</span>,
  read_only <span class='op'>=</span> <span class='cn'>FALSE</span>,
  storage_format <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"double"</span>, <span class='st'>"integer"</span><span class='op'>)</span>,
  meta_name <span class='op'>=</span> <span class='st'>"lazyarray.meta"</span>
<span class='op'>)</span>

<span class='fu'>as.lazymatrix</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='fu'>as.lazyarray</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>path</span>, type <span class='op'>=</span> <span class='st'>"filearray"</span>, <span class='va'>...</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>path</th>
      <td><p>path to a local drive where array data should be stored</p></td>
    </tr>
    <tr>
      <th>dim</th>
      <td><p>integer vector, dimension of array, see <code><a href='https://rdrr.io/r/base/dim.html'>dim</a></code></p></td>
    </tr>
    <tr>
      <th>read_only</th>
      <td><p>whether created array is read-only</p></td>
    </tr>
    <tr>
      <th>type</th>
      <td><p>the back-end implementation of the array; choices are 
<code>"filearray"</code> and <code>"fstarray"</code>.</p></td>
    </tr>
    <tr>
      <th>storage_format</th>
      <td><p>data type, choices are <code>"double"</code>, 
<code>"integer"</code>, <code>"character"</code>, and <code>"complex"</code>; see details</p></td>
    </tr>
    <tr>
      <th>meta_name</th>
      <td><p>header file name, default is <code>"lazyarray.meta"</code></p></td>
    </tr>
    <tr>
      <th>x</th>
      <td><p>An R matrix or array</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>passed into <code>lazyarray</code></p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An <code>R6</code> class of <code>lazyarray</code>. The class name is either
<code>FstArray</code> or <code>FileArray</code>, depending on <code>type</code> specified.
Both inherit <code>AbstractLazyArray</code>.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The function <code>lazyarray()</code> can either create or load an array
on the hard drives. When <code>path</code> exists as a directory, and there is
a valid array instance stored, <code>lazyarray</code> will ignore other parameters
such as <code>storage_format</code>, <code>type</code>, and sometimes <code>dim</code> (see 
Section "Array Partitions"). The function will try to load the existing array
given by the descriptive meta file. When <code>path</code> is missing or there is 
no valid array files inside of the directory, then a new array will be 
spawned, and <code>path</code> will be created automatically if it is missing.</p>
<p>There are two back-end implementations for <code>lazyarray()</code>:
<code>"filearray"</code> and <code>"fstarray"</code>. You can use <code>type</code> to 
specify which implementation serves your needs. There are some differences
between these two types. Each one has its own strengths and weaknesses. 
Please see Section "Array Types" for more details.</p>
<p>The argument <code>meta_name</code> specifies the name of file which stores
all the attribute information such as the total dimension, partition size,
file format, and storage format etc. There could be multiple meta files for 
the same array object; see Section "Array Partitions" for details.</p>
    <h2 class="hasAnchor" id="array-types"><a class="anchor" href="#array-types"></a>Array Types</h2>

    


<p>Type <code>filearray</code> stores data in its binary form "as-is" to the local
drives. This format is compatible with the package <code>filematrix</code>.
The data types supported are integers and double-float numbers.</p>
<p>Type <code>fstarray</code> stores data in <code>fst</code> format defined by the 
package <code>fstcore</code> using 'ZSTD' compression technique. Unlike 
<code>filearray</code>, <code>fstarray</code> supports complex numbers and string 
characters in addition to integer and double numbers.</p>
<p>The performance on solid-state drives mounted on 'NVMe' shows 
<code>filearray</code> can reach up to 3 GB per second for reading speed and 
<code>fstarray</code> can reach up to 1 GB per second.</p>
<p>By default, <code>filearray</code> will be used if the storage format is supported,
and <code>fstarray</code> is the back-up option. However, if the array data is
structured or ordered, or the storage size is a major concern, 
<code>fstarray</code> might achieve a better performance because it compresses 
data before writing to hard drive.</p>
<p>To explicitly create file array, use the function <code>filearray()</code>. 
Similarly, use <code>fstarray()</code> to create <code>fst</code>-based array.</p>
    <h2 class="hasAnchor" id="array-partitions"><a class="anchor" href="#array-partitions"></a>Array Partitions</h2>

    


<p>A <code>lazyarray</code> partitions data in two ways: file partitions and in-file
blocks.</p>
<p>1. File-level Partition:</p>
<p>The number of file partitions matches with the last array margin.
Given a \(100 x 200 x 30 x 4\) array, there will be 4 partitions, each
partition stores a slice of data containing a \(100 x 200 x 30\) 
sub-array, or \(2,400,000\) elements.</p>
<p>Once an array is created, the length of each partition does not change 
anymore. However, the shape of each partition can be changed. The number of
partitions can grow or trim. To change these, you just need to create a 
new meta file and specify the new dimension at no additional cost. Use 
the previous example. The partition sub-dimension can be 
\(10000 x 60\), \(2000 x 300\), or \(1000 x 200 x 3\) as
long as the total length matches. The total partitions can change to 
3, 5, or 100, or any positive integer. To change the total dimension to 
\(2400000 x 100\), you can call <code>lazyarray</code> with the new dimension (
see examples). Please make sure the <code>type</code> and <code>meta_name</code> are 
specified.</p>
<p>2. In-file Blocks:</p>
<p>Within each file, the data are stored in blocks. When reading the data, if
an element within each block is used, then the whole block gets read.</p>
<p>For <code>filearray</code>, the block size equals to the first margin. For 
example, a \(100 x 200 x 3\) file array will have 3 file partitions,
200 blocks, each block has 100 elements</p>
<p>As for <code>fstarray</code>, the lower bound of block size can be set by 
<code><a href='https://rdrr.io/r/base/options.html'>options(lazyarray.fstarray.blocksize=...)</a></code>. By default, this number is
16,384. For a \(100 x 200 x 3\) array, each partition only has one block
and block number if 20,000.</p>
    <h2 class="hasAnchor" id="indexing-and-recommended-dimension-settings"><a class="anchor" href="#indexing-and-recommended-dimension-settings"></a>Indexing and Recommended Dimension Settings</h2>

    


<p>If there is a dimension that defines the unit of analysis, then make it the 
last margin index. If a margin is rarely indexed, put it in the first margin.
This is because indexing along the last margin is the fastest, and indexing
along the first margin is the slowest.</p>
<p>If <code>x</code> has \(200 x 200 x 200\) dimension, <code>x[,,i]</code> is the 
fastest, then <code>x[,i,]</code>, then <code>x[i,,]</code>.</p>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Zhengjia Wang</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/dipterix/lazyarray'>lazyarray</a></span><span class='op'>)</span>

<span class='va'>path</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/tempfile.html'>tempfile</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># ---------------- case 1: Create new array ------------------</span>
<span class='va'>arr</span> <span class='op'>&lt;-</span> <span class='fu'>lazyarray</span><span class='op'>(</span><span class='va'>path</span>, storage_format <span class='op'>=</span> <span class='st'>'double'</span>, dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2</span>,<span class='fl'>3</span>,<span class='fl'>4</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>arr</span><span class='op'>[</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>24</span>

<span class='co'># Subset and get the first partition</span>
<span class='va'>arr</span><span class='op'>[</span>,,<span class='fl'>1</span><span class='op'>]</span>
</div><div class='output co'>#&gt;      [,1] [,2] [,3]
#&gt; [1,]    1    3    5
#&gt; [2,]    2    4    6</div><div class='input'>
<span class='co'># Partition file path (total 4 partitions)</span>
<span class='va'>arr</span><span class='op'>$</span><span class='fu'>get_partition_fpath</span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpoOCypJ/file86f16d77f68/1.bmat"
#&gt; [2] "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpoOCypJ/file86f16d77f68/2.bmat"
#&gt; [3] "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpoOCypJ/file86f16d77f68/3.bmat"
#&gt; [4] "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpoOCypJ/file86f16d77f68/4.bmat"</div><div class='input'>
<span class='co'># Removing array doesn't clear the data</span>
<span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span><span class='va'>arr</span><span class='op'>)</span>; <span class='fu'><a href='https://rdrr.io/r/base/gc.html'>gc</a></span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt;           used (Mb) gc trigger (Mb) limit (Mb) max used (Mb)
#&gt; Ncells  979804 52.4    1821330 97.3         NA  1821330 97.3
#&gt; Vcells 1845846 14.1    8388608 64.0      16384  2828298 21.6</div><div class='input'>
<span class='co'># ---------------- Case 2: Load from existing directory ----------------</span>
<span class='co'># Load from existing path, no need to specify other params</span>
<span class='va'>arr</span> <span class='op'>&lt;-</span> <span class='fu'>lazyarray</span><span class='op'>(</span><span class='va'>path</span>, read_only <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>arr</span>, quiet <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Class:      [FileArray -&gt; AbstractLazyArray -&gt; R6]
#&gt; Type:       [double]
#&gt; Dimension:  [2 x 3 x 4]
#&gt; Dimension names: None
#&gt; Partitions: [4]
#&gt; Partition summaries: 
#&gt;   Min Max Mean Standard Deviation NAs Length
#&gt; 1   1   6  3.5           1.870829   0      6
#&gt; 2   7  12  9.5           1.870829   0      6
#&gt; 3  13  18 15.5           1.870829   0      6
#&gt; 4  19  24 21.5           1.870829   0      6
#&gt; * Partition summary values use `na.rm=TRUE`
#&gt; ** Partition summary are generated from cache. If you have changed data recently, please re-run `x$generate_summary()`
#&gt; </div><div class='input'>
<span class='co'># ---------------- Case 3: Import from existing data ----------------</span>

<span class='co'># Change dimension to 6 x 20</span>

<span class='va'>arr1</span> <span class='op'>&lt;-</span> <span class='fu'>lazyarray</span><span class='op'>(</span><span class='va'>path</span>, dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>6</span>,<span class='fl'>20</span><span class='op'>)</span>, meta_name <span class='op'>=</span> <span class='st'>"arr_6x20.meta"</span><span class='op'>)</span>

<span class='va'>arr1</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>:</span><span class='fl'>5</span><span class='op'>]</span>
</div><div class='output co'>#&gt;      [,1] [,2] [,3] [,4] [,5]
#&gt; [1,]    1    7   13   19   NA
#&gt; [2,]    2    8   14   20   NA
#&gt; [3,]    3    9   15   21   NA
#&gt; [4,]    4   10   16   22   NA
#&gt; [5,]    5   11   17   23   NA
#&gt; [6,]    6   12   18   24   NA</div><div class='input'>
<span class='va'>arr1</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>:</span><span class='fl'>6</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>36</span><span class='op'>)</span>

<span class='co'># arr also changes</span>
<span class='va'>arr</span><span class='op'>[</span>,,<span class='fl'>1</span><span class='op'>]</span>
</div><div class='output co'>#&gt;              [,1]      [,2]       [,3]
#&gt; [1,] -2.437263611 0.6215527 -1.8218177
#&gt; [2,] -0.005571287 1.1484116 -0.2473253</div><div class='input'>

<span class='co'># ---------------- Case 4: Converting from R arrays ----------------</span>

<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>16</span>, <span class='fl'>4</span><span class='op'>)</span>
<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'>as.lazymatrix</span><span class='op'>(</span><span class='va'>x</span>, type <span class='op'>=</span> <span class='st'>'fstarray'</span>, storage_format <span class='op'>=</span> <span class='st'>"complex"</span><span class='op'>)</span>
<span class='va'>x</span><span class='op'>[</span>,<span class='op'>]</span>  <span class='co'># or x[]</span>
</div><div class='output co'>#&gt;      [,1] [,2]  [,3]  [,4]
#&gt; [1,] 1+0i 5+0i  9+0i 13+0i
#&gt; [2,] 2+0i 6+0i 10+0i 14+0i
#&gt; [3,] 3+0i 7+0i 11+0i 15+0i
#&gt; [4,] 4+0i 8+0i 12+0i 16+0i</div><div class='input'>


</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Zhengjia Wang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


